name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-get-version:
    name: Determine Version
    runs-on: ubuntu-22.04
    outputs:
      SemVer: ${{ steps.get-version.outputs.SemVer }}
      legacySemVerPadded: ${{ steps.get-version.outputs.legacySemVerPadded }}
      nuGetVersionV2: ${{ steps.get-version.outputs.nuGetVersionV2 }}
      AssemblySemVer: ${{ steps.get-version.outputs.AssemblySemVer }}
    steps:
      - name: Checkout
        uses: tesourohq/Tesouro-Github-Actions/common-actions/checkout@main
        with:
          fetch-depth: 0

      - id: get-version
        uses: tesourohq/Tesouro-Github-Actions/get-version@main

  ci-build-and-test:
    name: Build, Restore, and Test
    runs-on: ubuntu-22.04
    permissions:
      checks: write
      contents: write
      id-token: write
      pull-requests: write
      security-events: write
      statuses: write
    steps:
      - name: Checkout
        uses: tesourohq/Tesouro-Github-Actions/common-actions/checkout@main
        with:
          fetch-depth: 0

      - id: build-and-test
        uses: tesourohq/Tesouro-Github-Actions/build-and-test@main
        with:
          gh-packages-token: ${{ secrets.GH_PACKAGES_TOKEN }}
          solution-file: ./Npgsql.sln
          dotnet-version: 9.0.100
          code-coverage: '80 95'

  ci-package-publish-npgsql:
    name: Package and Publish Npgsql Fork
    runs-on: ubuntu-22.04
    needs: [ ci-get-version, ci-build-and-test ]
    steps:
      - name: Checkout
        uses: tesourohq/Tesouro-Github-Actions/common-actions/checkout@main
        with:
          fetch-depth: 0

      - name: Package and Publish
        uses: tesourohq/Tesouro-Github-Actions/package-and-publish@main
        with:
          sem-ver: ${{ needs.ci-get-version.outputs.SemVer }}
          assembly-ver: ${{ needs.ci-get-version.outputs.AssemblySemVer }}
          info-ver: ${{ needs.ci-get-version.outputs.InformationalVersion }}
          gh-packages-token: ${{ secrets.GH_PACKAGES_TOKEN }}
          project-file: ./src/Npgsql/Npgsql.csproj
          dotnet-version: 9.0.100

  slack-notify:
    name: Slack Notify
    if: (failure() || cancelled()) && github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    needs: [ ci-package-publish-npgsql ]
    steps:
      - uses: tesourohq/Tesouro-Github-Actions/slack-notify@main
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}